<div class="highlight"><pre><a name="l-1"></a><span class="cp">&lt;?php</span> 
<a name="l-2"></a><span class="c1">// This file is part of Moodle - http://moodle.org/</span>
<a name="l-3"></a><span class="c1">//</span>
<a name="l-4"></a><span class="c1">// Moodle is free software: you can redistribute it and/or modify</span>
<a name="l-5"></a><span class="c1">// it under the terms of the GNU General Public License as published by</span>
<a name="l-6"></a><span class="c1">// the Free Software Foundation, either version 3 of the License, or</span>
<a name="l-7"></a><span class="c1">// (at your option) any later version.</span>
<a name="l-8"></a><span class="c1">//</span>
<a name="l-9"></a><span class="c1">// Moodle is distributed in the hope that it will be useful,</span>
<a name="l-10"></a><span class="c1">// but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l-11"></a><span class="c1">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l-12"></a><span class="c1">// GNU General Public License for more details.</span>
<a name="l-13"></a><span class="c1">//</span>
<a name="l-14"></a><span class="c1">// You should have received a copy of the GNU General Public License</span>
<a name="l-15"></a><span class="c1">// along with Moodle.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<a name="l-16"></a>
<a name="l-17"></a>
<a name="l-18"></a><span class="sd">/**</span>
<a name="l-19"></a><span class="sd"> * Defines, displays and processes the settings form</span>
<a name="l-20"></a><span class="sd"> *</span>
<a name="l-21"></a><span class="sd"> * Since normal settings.php behaviour doesn&#39;t appear to apply to admin reports,</span>
<a name="l-22"></a><span class="sd"> * this page creates, displays and processess a form for configuring the report.</span>
<a name="l-23"></a><span class="sd"> *</span>
<a name="l-24"></a><span class="sd"> * @package report</span>
<a name="l-25"></a><span class="sd"> * @subpackage targetgrades</span>
<a name="l-26"></a><span class="sd"> * @author      Mark Johnson &lt;mark.johnson@tauntons.ac.uk&gt;</span>
<a name="l-27"></a><span class="sd"> * @copyright   2011 Tauntons College, UK</span>
<a name="l-28"></a><span class="sd"> * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later</span>
<a name="l-29"></a><span class="sd"> */</span> 
<a name="l-30"></a>
<a name="l-31"></a><span class="k">require_once</span><span class="p">(</span><span class="s1">&#39;../../../config.php&#39;</span><span class="p">);</span>
<a name="l-32"></a><span class="k">require_once</span><span class="p">(</span><span class="nv">$CFG</span><span class="o">-&gt;</span><span class="na">dirroot</span><span class="o">.</span><span class="s1">&#39;/lib/formslib.php&#39;</span><span class="p">);</span>
<a name="l-33"></a><span class="k">require_once</span><span class="p">(</span><span class="nv">$CFG</span><span class="o">-&gt;</span><span class="na">libdir</span><span class="o">.</span><span class="s1">&#39;/adminlib.php&#39;</span><span class="p">);</span>
<a name="l-34"></a><span class="k">require_once</span><span class="p">(</span><span class="nv">$CFG</span><span class="o">-&gt;</span><span class="na">dirroot</span><span class="o">.</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="nv">$CFG</span><span class="o">-&gt;</span><span class="na">admin</span><span class="o">.</span><span class="s1">&#39;/report/targetgrades/lib.php&#39;</span><span class="p">);</span>
<a name="l-35"></a>
<a name="l-36"></a><span class="k">use</span> <span class="nx">report\targetgrades</span> <span class="k">as</span> <span class="nx">tg</span><span class="p">;</span>
<a name="l-37"></a>
<a name="l-38"></a><span class="nx">require_login</span><span class="p">(</span><span class="nv">$SITE</span><span class="p">);</span>
<a name="l-39"></a><span class="nx">admin_externalpage_setup</span><span class="p">(</span><span class="s1">&#39;reporttargetgrades&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="nv">$CFG</span><span class="o">-&gt;</span><span class="na">admin</span><span class="o">.</span><span class="s1">&#39;/report/targetgrades/settingsform.php&#39;</span><span class="p">);</span>
<a name="l-40"></a><span class="nv">$PAGE</span><span class="o">-&gt;</span><span class="na">navbar</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;settings&#39;</span><span class="p">));</span>
<a name="l-41"></a>
<a name="l-42"></a><span class="sd">/**</span>
<a name="l-43"></a><span class="sd"> * Defines the class for the settings form</span>
<a name="l-44"></a><span class="sd"> * </span>
<a name="l-45"></a><span class="sd"> * Defines the form elements for editing settings, validates and processes the input.</span>
<a name="l-46"></a><span class="sd"> * </span>
<a name="l-47"></a><span class="sd"> */</span>
<a name="l-48"></a><span class="k">class</span> <span class="nc">report_targetgrades_settingsform</span> <span class="k">extends</span> <span class="nx">moodleform</span> <span class="p">{</span>
<a name="l-49"></a>    
<a name="l-50"></a>    <span class="sd">/**</span>
<a name="l-51"></a><span class="sd">     * Defines fields for editing the settings</span>
<a name="l-52"></a><span class="sd">     * </span>
<a name="l-53"></a><span class="sd">     * Defines fiels for editing the following settings for report_targetgrade:</span>
<a name="l-54"></a><span class="sd">     * group_length</span>
<a name="l-55"></a><span class="sd">     * group_field</span>
<a name="l-56"></a><span class="sd">     * gcse_field</span>
<a name="l-57"></a><span class="sd">     * roles</span>
<a name="l-58"></a><span class="sd">     * categories</span>
<a name="l-59"></a><span class="sd">     * exclude_field</span>
<a name="l-60"></a><span class="sd">     * exclude_regex</span>
<a name="l-61"></a><span class="sd">     * </span>
<a name="l-62"></a><span class="sd">     * @see lib/moodleform#definition()</span>
<a name="l-63"></a><span class="sd">     */</span>
<a name="l-64"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">definition</span><span class="p">()</span> <span class="p">{</span>
<a name="l-65"></a>        <span class="nv">$mform</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_form</span><span class="p">;</span>
<a name="l-66"></a>
<a name="l-67"></a>        <span class="nv">$fields</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_customdata</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">];</span>
<a name="l-68"></a>        <span class="nv">$userfields</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_customdata</span><span class="p">[</span><span class="s1">&#39;userfields&#39;</span><span class="p">];</span>
<a name="l-69"></a>        <span class="nv">$categories</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_customdata</span><span class="p">[</span><span class="s1">&#39;categories&#39;</span><span class="p">];</span>
<a name="l-70"></a>        <span class="nv">$roles</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_customdata</span><span class="p">[</span><span class="s1">&#39;roles&#39;</span><span class="p">];</span>
<a name="l-71"></a>        
<a name="l-72"></a>        <span class="sd">/**</span>
<a name="l-73"></a><span class="sd">         * Defines the number of characters to use for the pattern that matches courses</span>
<a name="l-74"></a><span class="sd">         * to a set of ALIS statistics</span>
<a name="l-75"></a><span class="sd">         */</span>
<a name="l-76"></a>        <span class="nv">$mform</span><span class="o">-&gt;</span><span class="na">addElement</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;group_length&#39;</span><span class="p">,</span> <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;group_length&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">));</span>
<a name="l-77"></a>        <span class="nv">$mform</span><span class="o">-&gt;</span><span class="na">setType</span><span class="p">(</span><span class="s1">&#39;group_length&#39;</span><span class="p">,</span> <span class="nx">PARAM_NUMBER</span><span class="p">);</span>        
<a name="l-78"></a>        
<a name="l-79"></a>        <span class="sd">/**</span>
<a name="l-80"></a><span class="sd">         * Defines the field to use for the pattern that matches courses against a set</span>
<a name="l-81"></a><span class="sd">         * of ALIS statistics</span>
<a name="l-82"></a><span class="sd">         */</span>
<a name="l-83"></a>        <span class="nv">$mform</span><span class="o">-&gt;</span><span class="na">addElement</span><span class="p">(</span><span class="s1">&#39;select&#39;</span><span class="p">,</span> <span class="s1">&#39;group_field&#39;</span><span class="p">,</span> <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;group_field&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">),</span> <span class="nv">$fields</span><span class="p">);</span>
<a name="l-84"></a>        <span class="nv">$mform</span><span class="o">-&gt;</span><span class="na">addHelpButton</span><span class="p">(</span><span class="s1">&#39;group_field&#39;</span><span class="p">,</span> <span class="s1">&#39;group_fielddesc&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">);</span>
<a name="l-85"></a>        
<a name="l-86"></a>        <span class="sd">/**</span>
<a name="l-87"></a><span class="sd">         * Defines the user field where the average GCSE scrore is stored</span>
<a name="l-88"></a><span class="sd">         */</span>
<a name="l-89"></a>        <span class="nv">$mform</span><span class="o">-&gt;</span><span class="na">addElement</span><span class="p">(</span><span class="s1">&#39;select&#39;</span><span class="p">,</span> <span class="s1">&#39;gcse_field&#39;</span><span class="p">,</span> <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;gcse_field&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">),</span> <span class="nb">array_merge</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="nv">$userfields</span><span class="p">));</span>
<a name="l-90"></a>        <span class="nv">$mform</span><span class="o">-&gt;</span><span class="na">addHelpButton</span><span class="p">(</span><span class="s1">&#39;gcse_field&#39;</span><span class="p">,</span> <span class="s1">&#39;gcse_field&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">);</span>
<a name="l-91"></a>        <span class="nv">$mform</span><span class="o">-&gt;</span><span class="na">addRule</span><span class="p">(</span><span class="s1">&#39;gcse_field&#39;</span><span class="p">,</span> <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;err_gcsefield&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">),</span> <span class="s1">&#39;nonzero&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="s1">&#39;client&#39;</span><span class="p">);</span>
<a name="l-92"></a>        <span class="nv">$mform</span><span class="o">-&gt;</span><span class="na">addRule</span><span class="p">(</span><span class="s1">&#39;gcse_field&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="s1">&#39;required&#39;</span><span class="p">);</span>
<a name="l-93"></a>        
<a name="l-94"></a>        <span class="sd">/**</span>
<a name="l-95"></a><span class="sd">         * Defines the roles to which target grades should be distributed</span>
<a name="l-96"></a><span class="sd">         */</span>
<a name="l-97"></a>        <span class="nv">$roleselect</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nv">$mform</span><span class="o">-&gt;</span><span class="na">addElement</span><span class="p">(</span><span class="s1">&#39;select&#39;</span><span class="p">,</span> <span class="s1">&#39;roles&#39;</span><span class="p">,</span> <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;roles&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">),</span> <span class="nv">$roles</span><span class="p">);</span>
<a name="l-98"></a>        <span class="nv">$roleselect</span><span class="o">-&gt;</span><span class="na">setMultiple</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
<a name="l-99"></a>        <span class="nv">$mform</span><span class="o">-&gt;</span><span class="na">setDefault</span><span class="p">(</span><span class="s1">&#39;roles&#39;</span><span class="p">,</span> <span class="nb">array_keys</span><span class="p">(</span><span class="nv">$roles</span><span class="p">));</span>
<a name="l-100"></a>        <span class="nv">$mform</span><span class="o">-&gt;</span><span class="na">addHelpButton</span><span class="p">(</span><span class="s1">&#39;roles&#39;</span><span class="p">,</span> <span class="s1">&#39;roles&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">);</span>
<a name="l-101"></a>        <span class="nv">$mform</span><span class="o">-&gt;</span><span class="na">addRule</span><span class="p">(</span><span class="s1">&#39;roles&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="s1">&#39;required&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="s1">&#39;client&#39;</span><span class="p">);</span>
<a name="l-102"></a>        
<a name="l-103"></a>        <span class="sd">/**</span>
<a name="l-104"></a><span class="sd">         * Defines the course categories that should be made available for distribution</span>
<a name="l-105"></a><span class="sd">         */</span>
<a name="l-106"></a>        <span class="nv">$catselect</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nv">$mform</span><span class="o">-&gt;</span><span class="na">addElement</span><span class="p">(</span><span class="s1">&#39;select&#39;</span><span class="p">,</span> <span class="s1">&#39;categories&#39;</span><span class="p">,</span> <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;categories&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">),</span> <span class="nv">$categories</span><span class="p">);</span>
<a name="l-107"></a>        <span class="nv">$catselect</span><span class="o">-&gt;</span><span class="na">setMultiple</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
<a name="l-108"></a>        <span class="nv">$mform</span><span class="o">-&gt;</span><span class="na">setDefault</span><span class="p">(</span><span class="s1">&#39;categories&#39;</span><span class="p">,</span> <span class="nb">array_keys</span><span class="p">(</span><span class="nv">$categories</span><span class="p">));</span>
<a name="l-109"></a>        <span class="nv">$mform</span><span class="o">-&gt;</span><span class="na">addHelpButton</span><span class="p">(</span><span class="s1">&#39;categories&#39;</span><span class="p">,</span> <span class="s1">&#39;categories&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">);</span>
<a name="l-110"></a>        <span class="nv">$mform</span><span class="o">-&gt;</span><span class="na">addRule</span><span class="p">(</span><span class="s1">&#39;categories&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="s1">&#39;required&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="s1">&#39;client&#39;</span><span class="p">);</span>
<a name="l-111"></a>        
<a name="l-112"></a>        <span class="sd">/**</span>
<a name="l-113"></a><span class="sd">         * Defines the field that should be matched to the regex to find which courses</span>
<a name="l-114"></a><span class="sd">         * should NOT be available for distribution</span>
<a name="l-115"></a><span class="sd">         */</span>
<a name="l-116"></a>        <span class="nv">$mform</span><span class="o">-&gt;</span><span class="na">addElement</span><span class="p">(</span><span class="s1">&#39;select&#39;</span><span class="p">,</span> <span class="s1">&#39;exclude_field&#39;</span><span class="p">,</span> <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;exclude_field&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">),</span> <span class="nv">$fields</span><span class="p">);</span>
<a name="l-117"></a>        
<a name="l-118"></a>        <span class="sd">/**</span>
<a name="l-119"></a><span class="sd">         * Defines the regex that the above field should be matched against to find</span>
<a name="l-120"></a><span class="sd">         * courses which should NOT be available for distribution</span>
<a name="l-121"></a><span class="sd">         */</span>
<a name="l-122"></a>        <span class="nv">$mform</span><span class="o">-&gt;</span><span class="na">addElement</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;exclude_regex&#39;</span><span class="p">,</span> <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;exclude_regex&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">));</span>
<a name="l-123"></a>        <span class="nv">$mform</span><span class="o">-&gt;</span><span class="na">addHelpButton</span><span class="p">(</span><span class="s1">&#39;exclude_regex&#39;</span><span class="p">,</span> <span class="s1">&#39;exclude_regexdesc&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">);</span>
<a name="l-124"></a>        
<a name="l-125"></a>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">add_action_buttons</span><span class="p">();</span>
<a name="l-126"></a>    <span class="p">}</span>
<a name="l-127"></a>    
<a name="l-128"></a>    <span class="sd">/**</span>
<a name="l-129"></a><span class="sd">     * Validates input</span>
<a name="l-130"></a><span class="sd">     * </span>
<a name="l-131"></a><span class="sd">     * Validates the exclude regex to ensure that it doesn&#39;t pose a risk </span>
<a name="l-132"></a><span class="sd">     * of ReDOS, and checks that settings used together </span>
<a name="l-133"></a><span class="sd">     * (group_length/groupfield and exclude_regex/exlude_field) are both </span>
<a name="l-134"></a><span class="sd">     * defined if either are.</span>
<a name="l-135"></a><span class="sd">     * </span>
<a name="l-136"></a><span class="sd">     * @param $data The data submitted to the form</span>
<a name="l-137"></a><span class="sd">     * @see lib/moodleform#validation($data, $files)</span>
<a name="l-138"></a><span class="sd">     */</span>
<a name="l-139"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">validation</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
<a name="l-140"></a>        <span class="nv">$errors</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<a name="l-141"></a>		<span class="k">if</span><span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">&#39;/(.+?\.?[*+].*?)[*+]/&#39;</span><span class="p">,</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;exclude_regex&#39;</span><span class="p">]))</span> <span class="p">{</span>
<a name="l-142"></a>		    <span class="nv">$errors</span><span class="p">[</span><span class="s1">&#39;exclude_regex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;unsaferegex&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">);</span>
<a name="l-143"></a>		<span class="p">}</span>
<a name="l-144"></a>		
<a name="l-145"></a>		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;group_length&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;group_field&#39;</span><span class="p">]))</span> <span class="p">{</span>
<a name="l-146"></a>		    <span class="nv">$errors</span><span class="p">[</span><span class="s1">&#39;group_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;err_group_field&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">);</span>    
<a name="l-147"></a>		<span class="p">}</span>
<a name="l-148"></a>		<span class="k">if</span><span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;group_length&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;group_field&#39;</span><span class="p">]))</span> <span class="p">{</span>
<a name="l-149"></a>		    <span class="nv">$errors</span><span class="p">[</span><span class="s1">&#39;group_length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;err_group_length&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">);</span>    
<a name="l-150"></a>		<span class="p">}</span>
<a name="l-151"></a>		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;exclude_regex&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;exclude_field&#39;</span><span class="p">]))</span> <span class="p">{</span>
<a name="l-152"></a>		    <span class="nv">$errors</span><span class="p">[</span><span class="s1">&#39;exclude_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;err_exclude_field&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">);</span>    
<a name="l-153"></a>		<span class="p">}</span>
<a name="l-154"></a>        
<a name="l-155"></a>        <span class="k">return</span> <span class="nv">$errors</span><span class="p">;</span>
<a name="l-156"></a>    <span class="p">}</span>
<a name="l-157"></a>    
<a name="l-158"></a>    <span class="sd">/**</span>
<a name="l-159"></a><span class="sd">     * Processes the settings and saves them</span>
<a name="l-160"></a><span class="sd">     * </span>
<a name="l-161"></a><span class="sd">     * Takes the valid settings from the form, serialises the arrays and </span>
<a name="l-162"></a><span class="sd">     * saves them in the report&#39;s plugin config. </span>
<a name="l-163"></a><span class="sd">     * </span>
<a name="l-164"></a><span class="sd">     * @param $data</span>
<a name="l-165"></a><span class="sd">     */</span>
<a name="l-166"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">process</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
<a name="l-167"></a>        <span class="nv">$data</span><span class="o">-&gt;</span><span class="na">roles</span> <span class="o">=</span> <span class="nb">serialize</span><span class="p">(</span><span class="nv">$data</span><span class="o">-&gt;</span><span class="na">roles</span><span class="p">);</span>
<a name="l-168"></a>        <span class="nv">$data</span><span class="o">-&gt;</span><span class="na">categories</span> <span class="o">=</span> <span class="nb">serialize</span><span class="p">(</span><span class="nv">$data</span><span class="o">-&gt;</span><span class="na">categories</span><span class="p">);</span>
<a name="l-169"></a>        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$data</span> <span class="k">as</span> <span class="nv">$field</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span> 
<a name="l-170"></a>            <span class="nx">set_config</span><span class="p">(</span><span class="nv">$field</span><span class="p">,</span> <span class="nv">$value</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">);</span>
<a name="l-171"></a>        <span class="p">}</span>
<a name="l-172"></a>    <span class="p">}</span>
<a name="l-173"></a>    
<a name="l-174"></a><span class="p">}</span>
<a name="l-175"></a>
<a name="l-176"></a><span class="k">list</span><span class="p">(</span><span class="nv">$in_sql</span><span class="p">,</span> <span class="nv">$params</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">get_in_or_equal</span><span class="p">(</span><span class="nb">explode</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="nv">$CFG</span><span class="o">-&gt;</span><span class="na">gradebookroles</span><span class="p">));</span>
<a name="l-177"></a><span class="nv">$customdata</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
<a name="l-178"></a>	<span class="s1">&#39;fields&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
<a name="l-179"></a>	    <span class="s1">&#39;shortname&#39;</span> <span class="o">=&gt;</span> <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;shortname&#39;</span><span class="p">),</span>
<a name="l-180"></a>	    <span class="s1">&#39;fullname&#39;</span> <span class="o">=&gt;</span> <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;fullname&#39;</span><span class="p">),</span>
<a name="l-181"></a>	    <span class="s1">&#39;idnumber&#39;</span> <span class="o">=&gt;</span> <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;idnumber&#39;</span><span class="p">)),</span>	
<a name="l-182"></a>	<span class="s1">&#39;roles&#39;</span> <span class="o">=&gt;</span> <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">get_records_select_menu</span><span class="p">(</span><span class="s1">&#39;role&#39;</span><span class="p">,</span> <span class="s1">&#39;id &#39;</span><span class="o">.</span><span class="nv">$in_sql</span><span class="p">,</span> <span class="nv">$params</span><span class="p">),</span>	
<a name="l-183"></a>	<span class="s1">&#39;categories&#39;</span> <span class="o">=&gt;</span> <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">get_records_menu</span><span class="p">(</span><span class="s1">&#39;course_categories&#39;</span><span class="p">),</span>	
<a name="l-184"></a>	<span class="s1">&#39;userfields&#39;</span> <span class="o">=&gt;</span> <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">get_records_menu</span><span class="p">(</span><span class="s1">&#39;user_info_field&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;id, name&#39;</span><span class="p">)</span>
<a name="l-185"></a><span class="p">);</span>
<a name="l-186"></a>
<a name="l-187"></a><span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$customdata</span><span class="p">[</span><span class="s1">&#39;userfields&#39;</span><span class="p">]))</span> <span class="p">{</span>
<a name="l-188"></a>    <span class="k">throw</span> <span class="k">new</span> <span class="nx">moodle_exception</span><span class="p">(</span><span class="s1">&#39;err_nouserfields&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nx">moodle_url</span><span class="p">(</span><span class="s1">&#39;/user/profile/index.php&#39;</span><span class="p">));</span>
<a name="l-189"></a><span class="p">}</span>
<a name="l-190"></a>
<a name="l-191"></a><span class="nv">$form</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">report_targetgrades_settingsform</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="nv">$customdata</span><span class="p">);</span>
<a name="l-192"></a><span class="k">if</span> <span class="p">(</span><span class="nv">$config</span> <span class="o">=</span> <span class="nx">tg\get_config</span><span class="p">())</span> <span class="p">{</span>
<a name="l-193"></a>    <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">set_data</span><span class="p">(</span><span class="nv">$config</span><span class="p">);</span>
<a name="l-194"></a><span class="p">}</span>
<a name="l-195"></a><span class="k">if</span> <span class="p">(</span><span class="nv">$data</span> <span class="o">=</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">get_data</span><span class="p">())</span> <span class="p">{</span>
<a name="l-196"></a>   <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">process</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
<a name="l-197"></a>   <span class="nx">redirect</span><span class="p">(</span><span class="k">new</span> <span class="nx">moodle_url</span><span class="p">(</span><span class="s1">&#39;/admin/report/targetgrades&#39;</span><span class="p">),</span> <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;settingssaved&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">),</span> <span class="mi">3</span><span class="p">);</span> 
<a name="l-198"></a>   <span class="k">exit</span><span class="p">();</span>
<a name="l-199"></a><span class="p">}</span> 
<a name="l-200"></a>
<a name="l-201"></a><span class="k">echo</span> <span class="nv">$OUTPUT</span><span class="o">-&gt;</span><span class="na">header</span><span class="p">();</span>
<a name="l-202"></a><span class="k">echo</span> <span class="nx">tg\print_tabs</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<a name="l-203"></a><span class="nv">$form</span><span class="o">-&gt;</span><span class="na">display</span><span class="p">();</span>
<a name="l-204"></a><span class="k">echo</span> <span class="nv">$OUTPUT</span><span class="o">-&gt;</span><span class="na">footer</span><span class="p">();</span>
<a name="l-205"></a>
<a name="l-206"></a><span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
