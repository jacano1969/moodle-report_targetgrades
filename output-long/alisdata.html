<div class="highlight"><pre><a name="l-1"></a><span class="cp">&lt;?php</span>
<a name="l-2"></a><span class="c1">// This file is part of Moodle - http://moodle.org/</span>
<a name="l-3"></a><span class="c1">//</span>
<a name="l-4"></a><span class="c1">// Moodle is free software: you can redistribute it and/or modify</span>
<a name="l-5"></a><span class="c1">// it under the terms of the GNU General Public License as published by</span>
<a name="l-6"></a><span class="c1">// the Free Software Foundation, either version 3 of the License, or</span>
<a name="l-7"></a><span class="c1">// (at your option) any later version.</span>
<a name="l-8"></a><span class="c1">//</span>
<a name="l-9"></a><span class="c1">// Moodle is distributed in the hope that it will be useful,</span>
<a name="l-10"></a><span class="c1">// but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l-11"></a><span class="c1">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l-12"></a><span class="c1">// GNU General Public License for more details.</span>
<a name="l-13"></a><span class="c1">//</span>
<a name="l-14"></a><span class="c1">// You should have received a copy of the GNU General Public License</span>
<a name="l-15"></a><span class="c1">// along with Moodle.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<a name="l-16"></a>
<a name="l-17"></a>
<a name="l-18"></a><span class="sd">/**</span>
<a name="l-19"></a><span class="sd"> * Import ALIS statistics for target grade calculations</span>
<a name="l-20"></a><span class="sd"> *</span>
<a name="l-21"></a><span class="sd"> * Presents a form allowing a CSV file containing ALIS data (generated using</span>
<a name="l-22"></a><span class="sd"> * alis_pdf2csv.sh) to be uploaded. Once uploaded, a list of statistics is</span>
<a name="l-23"></a><span class="sd"> * displayed, allowing patterns to be defined for each set of statistics to be</span>
<a name="l-24"></a><span class="sd"> * applied to when grades are distributed.</span>
<a name="l-25"></a><span class="sd"> * </span>
<a name="l-26"></a><span class="sd"> * @package report</span>
<a name="l-27"></a><span class="sd"> * @subpackage targetgrades</span>
<a name="l-28"></a><span class="sd"> * @author      Mark Johnson &lt;mark.johnson@tauntons.ac.uk&gt;</span>
<a name="l-29"></a><span class="sd"> * @copyright   2011 Tauntons College, UK</span>
<a name="l-30"></a><span class="sd"> * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later</span>
<a name="l-31"></a><span class="sd"> */</span>
<a name="l-32"></a>
<a name="l-33"></a><span class="k">require_once</span><span class="p">(</span><span class="s1">&#39;../../../config.php&#39;</span><span class="p">);</span>
<a name="l-34"></a><span class="k">require_once</span><span class="p">(</span><span class="nv">$CFG</span><span class="o">-&gt;</span><span class="na">dirroot</span><span class="o">.</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="nv">$CFG</span><span class="o">-&gt;</span><span class="na">admin</span><span class="o">.</span><span class="s1">&#39;/report/targetgrades/alisdata_form.php&#39;</span><span class="p">);</span>
<a name="l-35"></a><span class="k">require_once</span><span class="p">(</span><span class="nv">$CFG</span><span class="o">-&gt;</span><span class="na">dirroot</span><span class="o">.</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="nv">$CFG</span><span class="o">-&gt;</span><span class="na">admin</span><span class="o">.</span><span class="s1">&#39;/report/targetgrades/lib.php&#39;</span><span class="p">);</span>
<a name="l-36"></a><span class="k">require_once</span><span class="p">(</span><span class="nv">$CFG</span><span class="o">-&gt;</span><span class="na">libdir</span><span class="o">.</span><span class="s1">&#39;/adminlib.php&#39;</span><span class="p">);</span>
<a name="l-37"></a>
<a name="l-38"></a><span class="k">use</span> <span class="nx">report\targetgrades</span> <span class="k">as</span> <span class="nx">tg</span><span class="p">;</span>
<a name="l-39"></a>
<a name="l-40"></a><span class="nx">require_login</span><span class="p">(</span><span class="nv">$SITE</span><span class="p">);</span>
<a name="l-41"></a><span class="nx">admin_externalpage_setup</span><span class="p">(</span><span class="s1">&#39;reporttargetgrades&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="nv">$CFG</span><span class="o">-&gt;</span><span class="na">admin</span><span class="o">.</span><span class="s1">&#39;/report/targetgrades/alisdata.php&#39;</span><span class="p">);</span>
<a name="l-42"></a><span class="nv">$PAGE</span><span class="o">-&gt;</span><span class="na">navbar</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;alisdata&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">));</span>
<a name="l-43"></a>
<a name="l-44"></a><span class="nv">$savepatterns</span> <span class="o">=</span> <span class="nx">optional_param</span><span class="p">(</span><span class="s1">&#39;savepatterns&#39;</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="nx">PARAM_BOOL</span><span class="p">);</span>
<a name="l-45"></a><span class="nv">$alispatterns</span> <span class="o">=</span> <span class="nx">optional_param</span><span class="p">(</span><span class="s1">&#39;alispatterns&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(),</span> <span class="nx">PARAM_CLEAN</span><span class="p">);</span>
<a name="l-46"></a><span class="nv">$addpattern</span> <span class="o">=</span> <span class="nx">optional_param</span><span class="p">(</span><span class="s1">&#39;addpattern&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(),</span> <span class="nx">PARAM_CLEAN</span><span class="p">);</span>
<a name="l-47"></a><span class="nv">$config</span> <span class="o">=</span> <span class="nx">tg\get_config</span><span class="p">(</span><span class="s1">&#39;report_targetgrades&#39;</span><span class="p">);</span>
<a name="l-48"></a><span class="nv">$addfield</span> <span class="o">=</span> <span class="nx">optional_param</span><span class="p">(</span><span class="s1">&#39;addfield&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="nx">PARAM_INT</span><span class="p">);</span>
<a name="l-49"></a>
<a name="l-50"></a><span class="k">if</span> <span class="p">(</span><span class="nv">$savepatterns</span> <span class="o">||</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$addpattern</span><span class="p">))</span> <span class="p">{</span>
<a name="l-51"></a>    <span class="k">foreach</span><span class="p">(</span><span class="nv">$alispatterns</span> <span class="k">as</span> <span class="nv">$alisid</span> <span class="o">=&gt;</span> <span class="nv">$patterns</span><span class="p">)</span> <span class="p">{</span>
<a name="l-52"></a>        <span class="k">foreach</span><span class="p">(</span><span class="nv">$patterns</span> <span class="k">as</span> <span class="nv">$id</span> <span class="o">=&gt;</span> <span class="nv">$pattern</span><span class="p">)</span> <span class="p">{</span>
<a name="l-53"></a>            <span class="k">if</span> <span class="p">(</span><span class="nv">$alisdata</span> <span class="o">=</span> <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">get_record</span><span class="p">(</span><span class="s1">&#39;report_targetgrades_alisdata&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$alisid</span><span class="p">)))</span> <span class="p">{</span>                
<a name="l-54"></a>                <span class="k">if</span><span class="p">(</span><span class="nv">$patternrecord</span> <span class="o">=</span> <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">get_record</span><span class="p">(</span><span class="s1">&#39;report_targetgrades_patterns&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">)))</span> <span class="p">{</span>
<a name="l-55"></a>                    <span class="k">if</span><span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$pattern</span><span class="p">))</span> <span class="p">{</span>                        
<a name="l-56"></a>                        <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">delete_records</span><span class="p">(</span><span class="s1">&#39;report_targetgrades_patterns&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">));</span>
<a name="l-57"></a>                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="l-58"></a>                        <span class="nv">$patternrecord</span><span class="o">-&gt;</span><span class="na">pattern</span> <span class="o">=</span> <span class="nv">$pattern</span><span class="p">;</span>
<a name="l-59"></a>                        <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">update_record</span><span class="p">(</span><span class="s1">&#39;report_targetgrades_patterns&#39;</span><span class="p">,</span> <span class="nv">$patternrecord</span><span class="p">);</span>
<a name="l-60"></a>                    <span class="p">}</span>
<a name="l-61"></a>                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$pattern</span><span class="p">))</span> <span class="p">{</span>
<a name="l-62"></a>                    <span class="nv">$patternrecord</span> <span class="o">=</span> <span class="k">new</span> <span class="k">stdClass</span><span class="p">;</span>
<a name="l-63"></a>                    <span class="nv">$patternrecord</span><span class="o">-&gt;</span><span class="na">alisdataid</span> <span class="o">=</span> <span class="nv">$alisid</span><span class="p">;</span>
<a name="l-64"></a>                    <span class="nv">$patternrecord</span><span class="o">-&gt;</span><span class="na">pattern</span> <span class="o">=</span> <span class="nv">$pattern</span><span class="p">;</span>
<a name="l-65"></a>                    <span class="nv">$patternrecord</span><span class="o">-&gt;</span><span class="na">id</span> <span class="o">=</span> <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">insert_record</span><span class="p">(</span><span class="s1">&#39;report_targetgrades_patterns&#39;</span><span class="p">,</span> <span class="nv">$patternrecord</span><span class="p">);</span>
<a name="l-66"></a>                <span class="p">}</span>
<a name="l-67"></a>            <span class="p">}</span>            
<a name="l-68"></a>        <span class="p">}</span>
<a name="l-69"></a>    <span class="p">}</span>
<a name="l-70"></a>    <span class="nv">$output</span> <span class="o">=</span> <span class="s1">&#39;&lt;p&gt;&#39;</span><span class="o">.</span><span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;changessaved&#39;</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;&lt;/p&gt;&#39;</span><span class="p">;</span>
<a name="l-71"></a>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$addpattern</span><span class="p">))</span> <span class="p">{</span>
<a name="l-72"></a>        <span class="nx">redirect</span><span class="p">(</span><span class="k">new</span> <span class="nx">moodle_url</span><span class="p">(</span><span class="s1">&#39;/admin/report/targetgrades/alisdata.php#alis&#39;</span><span class="o">.</span><span class="nb">key</span><span class="p">(</span><span class="nv">$addpattern</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;addfield&#39;</span> <span class="o">=&gt;</span> <span class="nb">key</span><span class="p">(</span><span class="nv">$addpattern</span><span class="p">))));</span>
<a name="l-73"></a>    <span class="p">}</span>
<a name="l-74"></a><span class="p">}</span>
<a name="l-75"></a>
<a name="l-76"></a><span class="nv">$uploadform</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">tg\alisdata_upload_form</span><span class="p">();</span>
<a name="l-77"></a>
<a name="l-78"></a><span class="k">if</span> <span class="p">(</span><span class="nv">$uploaddata</span> <span class="o">=</span> <span class="nv">$uploadform</span><span class="o">-&gt;</span><span class="na">get_data</span><span class="p">())</span> <span class="p">{</span>
<a name="l-79"></a>    <span class="nv">$handler</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">tg\csvhandler</span><span class="p">(</span><span class="nv">$uploaddata</span><span class="o">-&gt;</span><span class="na">equationsfile</span><span class="p">);</span>
<a name="l-80"></a>    <span class="nv">$handler</span><span class="o">-&gt;</span><span class="na">validate</span><span class="p">();</span>
<a name="l-81"></a>    <span class="nv">$import</span> <span class="o">=</span> <span class="nv">$handler</span><span class="o">-&gt;</span><span class="na">process</span><span class="p">();</span>
<a name="l-82"></a>
<a name="l-83"></a>    <span class="nv">$output</span> <span class="o">=</span> <span class="s1">&#39;&lt;p&gt;&#39;</span><span class="o">.</span><span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;importoutput&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">,</span> <span class="nv">$import</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;&lt;/p&gt;&#39;</span><span class="p">;</span>
<a name="l-84"></a>
<a name="l-85"></a><span class="p">}</span>
<a name="l-86"></a>
<a name="l-87"></a><span class="nv">$select</span> <span class="o">=</span> <span class="s1">&#39;SELECT a.*, a.name AS subject, q.name AS qualification &#39;</span><span class="p">;</span>
<a name="l-88"></a><span class="nv">$from</span> <span class="o">=</span> <span class="s1">&#39;FROM {report_targetgrades_alisdata} a</span>
<a name="l-89"></a><span class="s1">    JOIN {report_targetgrades_qualtype} q ON a.qualtypeid = q.id &#39;</span><span class="p">;</span>
<a name="l-90"></a><span class="nv">$order</span> <span class="o">=</span> <span class="s1">&#39;ORDER BY q.name, a.name ASC&#39;</span><span class="p">;</span>
<a name="l-91"></a>
<a name="l-92"></a><span class="k">if</span><span class="p">(</span><span class="nv">$alis_data</span> <span class="o">=</span> <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">get_records_sql</span><span class="p">(</span><span class="nv">$select</span><span class="o">.</span><span class="nv">$from</span><span class="o">.</span><span class="nv">$order</span><span class="p">))</span> <span class="p">{</span>
<a name="l-93"></a>
<a name="l-94"></a>    <span class="nv">$table</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">html_table</span><span class="p">();</span>
<a name="l-95"></a>
<a name="l-96"></a>    <span class="c1">//$table-&gt;define_columns(array(&#39;qualtype&#39;, &#39;name&#39;, &#39;pattern&#39;, &#39;gradient&#39;, &#39;intercept&#39;));</span>
<a name="l-97"></a>    <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">head</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;col_qualtype&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">),</span>
<a name="l-98"></a>            <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;col_name&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">),</span>
<a name="l-99"></a>            <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;col_pattern&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">),</span>
<a name="l-100"></a>            <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;col_gradient&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">),</span>
<a name="l-101"></a>            <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;col_intercept&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">),</span>
<a name="l-102"></a>            <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;col_quality&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">)</span><span class="o">.</span><span class="nv">$OUTPUT</span><span class="o">-&gt;</span><span class="na">help_icon</span><span class="p">(</span><span class="s1">&#39;col_quality&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">));</span>    
<a name="l-103"></a>
<a name="l-104"></a>    <span class="k">try</span> <span class="p">{</span>
<a name="l-105"></a>        <span class="nv">$options</span> <span class="o">=</span> <span class="nx">tg\build_pattern_options</span><span class="p">();</span>
<a name="l-106"></a>    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">unsafe_regex_exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
<a name="l-107"></a>        <span class="nx">print_error</span><span class="p">(</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">(),</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">);</span>
<a name="l-108"></a>    <span class="p">}</span>
<a name="l-109"></a>    <span class="k">foreach</span><span class="p">(</span><span class="nv">$alis_data</span> <span class="k">as</span> <span class="nv">$alis</span><span class="p">)</span> <span class="p">{</span>
<a name="l-110"></a>        <span class="nv">$form</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
<a name="l-111"></a>        <span class="k">if</span><span class="p">(</span><span class="nv">$patterns</span> <span class="o">=</span> <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">get_records</span><span class="p">(</span><span class="s1">&#39;report_targetgrades_patterns&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;alisdataid&#39;</span> <span class="o">=&gt;</span> <span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">)))</span> <span class="p">{</span>
<a name="l-112"></a>            <span class="nv">$break</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="l-113"></a>            
<a name="l-114"></a>            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$patterns</span> <span class="k">as</span> <span class="nv">$pattern</span><span class="p">)</span> <span class="p">{</span>
<a name="l-115"></a>                <span class="nv">$optionswithpattern</span> <span class="o">=</span> <span class="nb">array_merge</span><span class="p">(</span><span class="nv">$options</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$pattern</span><span class="o">-&gt;</span><span class="na">pattern</span> <span class="o">=&gt;</span> <span class="nv">$pattern</span><span class="o">-&gt;</span><span class="na">pattern</span><span class="p">));</span>
<a name="l-116"></a>                <span class="nb">asort</span><span class="p">(</span><span class="nv">$optionswithpattern</span><span class="p">);</span>
<a name="l-117"></a>                <span class="nv">$form</span> <span class="o">.=</span> <span class="nx">html_writer</span><span class="o">::</span><span class="na">select</span><span class="p">(</span><span class="nv">$optionswithpattern</span><span class="p">,</span> <span class="s1">&#39;alispatterns[&#39;</span><span class="o">.</span><span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">id</span><span class="o">.</span><span class="s1">&#39;][&#39;</span><span class="o">.</span><span class="nv">$pattern</span><span class="o">-&gt;</span><span class="na">id</span><span class="o">.</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="nv">$pattern</span><span class="o">-&gt;</span><span class="na">pattern</span><span class="p">);</span>
<a name="l-118"></a>                <span class="k">if</span><span class="p">((</span><span class="nb">count</span><span class="p">(</span><span class="nv">$patterns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nv">$break</span> <span class="o">&lt;</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$patterns</span><span class="p">))</span> <span class="o">||</span> <span class="nv">$addfield</span> <span class="o">==</span> <span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">)</span> <span class="p">{</span>
<a name="l-119"></a>                    <span class="nv">$form</span> <span class="o">.=</span> <span class="nx">html_writer</span><span class="o">::</span><span class="na">empty_tag</span><span class="p">(</span><span class="s1">&#39;br&#39;</span><span class="p">);</span>
<a name="l-120"></a>                <span class="p">}</span>
<a name="l-121"></a>                <span class="nv">$break</span><span class="o">++</span><span class="p">;</span>
<a name="l-122"></a>            <span class="p">}</span>
<a name="l-123"></a>
<a name="l-124"></a>            <span class="k">if</span> <span class="p">(</span><span class="nv">$addfield</span> <span class="o">==</span> <span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">)</span> <span class="p">{</span>
<a name="l-125"></a>                <span class="nv">$form</span> <span class="o">.=</span> <span class="nx">html_writer</span><span class="o">::</span><span class="na">select</span><span class="p">(</span><span class="nv">$options</span><span class="p">,</span> <span class="s1">&#39;alispatterns[&#39;</span><span class="o">.</span><span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">id</span><span class="o">.</span><span class="s1">&#39;][]&#39;</span><span class="p">);</span>
<a name="l-126"></a>            <span class="p">}</span>
<a name="l-127"></a>            
<a name="l-128"></a>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="l-129"></a>            <span class="nv">$form</span> <span class="o">.=</span> <span class="nx">html_writer</span><span class="o">::</span><span class="na">select</span><span class="p">(</span><span class="nv">$options</span><span class="p">,</span> <span class="s1">&#39;alispatterns[&#39;</span><span class="o">.</span><span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">id</span><span class="o">.</span><span class="s1">&#39;][]&#39;</span><span class="p">);</span>
<a name="l-130"></a>        <span class="p">}</span>
<a name="l-131"></a>                
<a name="l-132"></a>        <span class="nv">$form</span> <span class="o">.=</span> <span class="nx">html_writer</span><span class="o">::</span><span class="na">empty_tag</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;submit&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;addpattern[&#39;</span><span class="o">.</span><span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">id</span><span class="o">.</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Save changes and Add another pattern&#39;</span><span class="p">));</span>
<a name="l-133"></a>        
<a name="l-134"></a>        <span class="nv">$quality</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>       
<a name="l-135"></a>        <span class="k">switch</span> <span class="p">(</span><span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">quality_samplesize</span><span class="p">)</span> <span class="p">{</span>
<a name="l-136"></a>            <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
<a name="l-137"></a>                <span class="nv">$quality</span><span class="p">[]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">object</span><span class="p">)</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;field&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;samplesize&#39;</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;oksize&#39;</span><span class="p">,</span> <span class="s1">&#39;class&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;ok&#39;</span><span class="p">,</span> <span class="s1">&#39;display&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;S&#39;</span><span class="p">);</span>                   
<a name="l-138"></a>                <span class="k">break</span><span class="p">;</span>
<a name="l-139"></a>            <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
<a name="l-140"></a>                <span class="nv">$quality</span><span class="p">[]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">object</span><span class="p">)</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;field&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;samplesize&#39;</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;lowsize&#39;</span><span class="p">,</span> <span class="s1">&#39;class&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;display&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;S&#39;</span><span class="p">);</span>                   
<a name="l-141"></a>                <span class="k">break</span><span class="p">;</span>
<a name="l-142"></a>            <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
<a name="l-143"></a>		        <span class="nv">$quality</span><span class="p">[]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">object</span><span class="p">)</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;field&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;samplesize&#39;</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;vlowsize&#39;</span><span class="p">,</span> <span class="s1">&#39;class&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;vlow&#39;</span><span class="p">,</span> <span class="s1">&#39;display&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;S&#39;</span><span class="p">);</span>
<a name="l-144"></a>                <span class="k">break</span><span class="p">;</span>
<a name="l-145"></a>        <span class="p">}</span>
<a name="l-146"></a>        
<a name="l-147"></a>        <span class="k">if</span><span class="p">(</span><span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">quality_correlation</span><span class="p">)</span> <span class="p">{</span>
<a name="l-148"></a>	            <span class="nv">$quality</span><span class="p">[]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">object</span><span class="p">)</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;field&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;correlation&#39;</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;lowcorrelation&#39;</span><span class="p">,</span> <span class="s1">&#39;class&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;display&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;C&#39;</span><span class="p">);</span>                   
<a name="l-149"></a>        <span class="p">}</span>
<a name="l-150"></a>        
<a name="l-151"></a>        <span class="k">switch</span> <span class="p">(</span><span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">quality_deviation</span><span class="p">)</span> <span class="p">{</span>
<a name="l-152"></a>            <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
<a name="l-153"></a>	            <span class="nv">$quality</span><span class="p">[]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">object</span><span class="p">)</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;field&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;standarddeviation&#39;</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;highdeviation&#39;</span><span class="p">,</span> <span class="s1">&#39;class&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;display&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;D&#39;</span><span class="p">);</span>                   
<a name="l-154"></a>                <span class="k">break</span><span class="p">;</span>
<a name="l-155"></a>            <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
<a name="l-156"></a>	            <span class="nv">$quality</span><span class="p">[]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">object</span><span class="p">)</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;field&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;standarddeviation&#39;</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;vhighdeviation&#39;</span><span class="p">,</span> <span class="s1">&#39;class&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;vlow&#39;</span><span class="p">,</span> <span class="s1">&#39;display&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;D&#39;</span><span class="p">);</span>                   
<a name="l-157"></a>                <span class="k">break</span><span class="p">;</span>
<a name="l-158"></a>        <span class="p">}</span>
<a name="l-159"></a>        
<a name="l-160"></a>        <span class="nv">$quality_html</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<a name="l-161"></a>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$quality</span><span class="p">))</span> <span class="p">{</span>
<a name="l-162"></a>            <span class="k">foreach</span><span class="p">(</span><span class="nv">$quality</span> <span class="k">as</span> <span class="nv">$status</span><span class="p">)</span> <span class="p">{</span>
<a name="l-163"></a>                <span class="nv">$field</span> <span class="o">=</span> <span class="nv">$status</span><span class="o">-&gt;</span><span class="na">field</span><span class="p">;</span>
<a name="l-164"></a>                <span class="nv">$quality_html</span><span class="p">[]</span> <span class="o">=</span> <span class="nx">html_writer</span><span class="o">::</span><span class="na">tag</span><span class="p">(</span><span class="s1">&#39;abbr&#39;</span><span class="p">,</span> <span class="nv">$status</span><span class="o">-&gt;</span><span class="na">display</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;class&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;tg_&#39;</span><span class="o">.</span><span class="nv">$status</span><span class="o">-&gt;</span><span class="na">class</span><span class="o">.</span><span class="s1">&#39;quality&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="nx">get_string</span><span class="p">(</span><span class="nv">$status</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">,</span> <span class="nv">$alis</span><span class="o">-&gt;</span><span class="nv">$field</span><span class="p">)));</span>
<a name="l-165"></a>            <span class="p">}</span>
<a name="l-166"></a>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="l-167"></a>            <span class="nv">$quality_html</span><span class="p">[]</span> <span class="o">=</span> <span class="nx">html_writer</span><span class="o">::</span><span class="na">empty_tag</span><span class="p">(</span><span class="s1">&#39;img&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;src&#39;</span> <span class="o">=&gt;</span> <span class="nv">$OUTPUT</span><span class="o">-&gt;</span><span class="na">pix_url</span><span class="p">(</span><span class="s1">&#39;i/tick_green_big&#39;</span><span class="p">),</span> <span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;okquality&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">)));</span>
<a name="l-168"></a>        <span class="p">}</span>
<a name="l-169"></a>
<a name="l-170"></a>        <span class="nv">$row</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">html_table_row</span><span class="p">;</span>
<a name="l-171"></a>        <span class="nv">$row</span><span class="o">-&gt;</span><span class="na">cells</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">qualification</span><span class="p">;</span>
<a name="l-172"></a>        <span class="nv">$row</span><span class="o">-&gt;</span><span class="na">cells</span><span class="p">[]</span> <span class="o">=</span> <span class="nx">html_writer</span><span class="o">::</span><span class="na">tag</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">subject</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;alis&#39;</span><span class="o">.</span><span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">));</span>
<a name="l-173"></a>        
<a name="l-174"></a>        <span class="nv">$row</span><span class="o">-&gt;</span><span class="na">cells</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$form</span><span class="p">;</span>
<a name="l-175"></a>        <span class="nv">$row</span><span class="o">-&gt;</span><span class="na">cells</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">gradient</span><span class="p">;</span>
<a name="l-176"></a>        <span class="nv">$row</span><span class="o">-&gt;</span><span class="na">cells</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">intercept</span><span class="p">;</span>
<a name="l-177"></a>        <span class="nv">$row</span><span class="o">-&gt;</span><span class="na">cells</span><span class="p">[]</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$quality_html</span><span class="p">);</span>
<a name="l-178"></a>        <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$row</span><span class="p">;</span>
<a name="l-179"></a>    <span class="p">}</span>
<a name="l-180"></a><span class="p">}</span>
<a name="l-181"></a>
<a name="l-182"></a>
<a name="l-183"></a>
<a name="l-184"></a><span class="k">echo</span> <span class="nv">$OUTPUT</span><span class="o">-&gt;</span><span class="na">header</span><span class="p">();</span>
<a name="l-185"></a><span class="nx">tg\print_tabs</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a name="l-186"></a>
<a name="l-187"></a><span class="k">echo</span> <span class="nx">html_writer</span><span class="o">::</span><span class="na">tag</span><span class="p">(</span><span class="s1">&#39;h2&#39;</span><span class="p">,</span> <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;alisdata&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">));</span>
<a name="l-188"></a><span class="k">echo</span> <span class="nx">html_writer</span><span class="o">::</span><span class="na">tag</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;configalis&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">));</span>
<a name="l-189"></a><span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$output</span><span class="p">))</span> <span class="p">{</span>
<a name="l-190"></a>    <span class="k">echo</span> <span class="nv">$output</span><span class="p">;</span>
<a name="l-191"></a><span class="p">}</span>
<a name="l-192"></a><span class="nv">$uploadform</span><span class="o">-&gt;</span><span class="na">display</span><span class="p">();</span>
<a name="l-193"></a><span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$table</span><span class="p">))</span> <span class="p">{</span>
<a name="l-194"></a>    <span class="k">echo</span> <span class="nx">html_writer</span><span class="o">::</span><span class="na">tag</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;explainpatterns&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">,</span> <span class="nv">$config</span><span class="p">));</span>
<a name="l-195"></a>    <span class="k">echo</span> <span class="nx">html_writer</span><span class="o">::</span><span class="na">start_tag</span><span class="p">(</span><span class="s1">&#39;form&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;action&#39;</span> <span class="o">=&gt;</span> <span class="nv">$PAGE</span><span class="o">-&gt;</span><span class="na">url</span><span class="o">-&gt;</span><span class="na">out</span><span class="p">(),</span> <span class="s1">&#39;method&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;post&#39;</span><span class="p">));</span>
<a name="l-196"></a>    <span class="k">echo</span> <span class="nx">html_writer</span><span class="o">::</span><span class="na">table</span><span class="p">(</span><span class="nv">$table</span><span class="p">);</span>
<a name="l-197"></a>    <span class="k">echo</span> <span class="nx">html_writer</span><span class="o">::</span><span class="na">empty_tag</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;submit&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;savepatterns&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span> <span class="o">=&gt;</span> <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;savechanges&#39;</span><span class="p">)));</span>
<a name="l-198"></a>    <span class="k">echo</span> <span class="nx">html_writer</span><span class="o">::</span><span class="na">end_tag</span><span class="p">(</span><span class="s1">&#39;form&#39;</span><span class="p">);</span>
<a name="l-199"></a><span class="p">}</span>
<a name="l-200"></a><span class="k">echo</span> <span class="nv">$OUTPUT</span><span class="o">-&gt;</span><span class="na">footer</span><span class="p">();</span>
<a name="l-201"></a>
<a name="l-202"></a><span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
