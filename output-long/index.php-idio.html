<div class="highlight"><pre><a name="l-1"></a><span class="cp">&lt;?php</span>
<a name="l-2"></a><span class="c1">// This file is part of Moodle - http://moodle.org/</span>
<a name="l-3"></a><span class="c1">//</span>
<a name="l-4"></a><span class="c1">// Moodle is free software: you can redistribute it and/or modify</span>
<a name="l-5"></a><span class="c1">// it under the terms of the GNU General Public License as published by</span>
<a name="l-6"></a><span class="c1">// the Free Software Foundation, either version 3 of the License, or</span>
<a name="l-7"></a><span class="c1">// (at your option) any later version.</span>
<a name="l-8"></a><span class="c1">//</span>
<a name="l-9"></a><span class="c1">// Moodle is distributed in the hope that it will be useful,</span>
<a name="l-10"></a><span class="c1">// but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l-11"></a><span class="c1">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l-12"></a><span class="c1">// GNU General Public License for more details.</span>
<a name="l-13"></a><span class="c1">//</span>
<a name="l-14"></a><span class="c1">// You should have received a copy of the GNU General Public License</span>
<a name="l-15"></a><span class="c1">// along with Moodle.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<a name="l-16"></a>
<a name="l-17"></a>
<a name="l-18"></a><span class="sd">/**</span>
<a name="l-19"></a><span class="sd"> * Determines whether the plugin is configured and directs the user to the appropriate page</span>
<a name="l-20"></a><span class="sd"> *</span>
<a name="l-21"></a><span class="sd"> * If the report is yet to be configured, the user is directed to the settings page.</span>
<a name="l-22"></a><span class="sd"> * If the report has been configured but there is no ALIS data, the user is directed to the</span>
<a name="l-23"></a><span class="sd"> * ALIS upload page.</span>
<a name="l-24"></a><span class="sd"> * If ALIS data is present, the user is directed to the Distribute page.</span>
<a name="l-25"></a><span class="sd"> * </span>
<a name="l-26"></a><span class="sd"> * @package report</span>
<a name="l-27"></a><span class="sd"> * @subpackage targetgrades</span>
<a name="l-28"></a><span class="sd"> * @author      Mark Johnson &lt;mark.johnson@tauntons.ac.uk&gt;</span>
<a name="l-29"></a><span class="sd"> * @copyright   2011 Tauntons College, UK</span>
<a name="l-30"></a><span class="sd"> * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later</span>
<a name="l-31"></a><span class="sd"> */</span> 
<a name="l-32"></a> 
<a name="l-33"></a><span class="k">require_once</span><span class="p">(</span><span class="s1">&#39;../../../config.php&#39;</span><span class="p">);</span>
<a name="l-34"></a><span class="k">require_once</span><span class="p">(</span><span class="nv">$CFG</span><span class="o">-&gt;</span><span class="na">dirroot</span><span class="o">.</span><span class="s1">&#39;/admin/report/targetgrades/lib.php&#39;</span><span class="p">);</span>
</pre></div>
<div class="highlight"><pre><a name="l-1"></a><span class="x">use report\targetgrades as tg;</span>
</pre></div>
<div class="highlight"><pre><a name="l-1"></a><span class="x">require_login($SITE);</span>
</pre></div>
<div class="highlight"><pre><a name="l-1"></a><span class="x">$config = tg\get_config(&#39;report_targetgrades&#39;);</span>
</pre></div>
<div class="highlight"><pre><a name="l-1"></a><span class="x">try {</span>
<a name="l-2"></a><span class="x">    if(!empty($config-&gt;roles) &amp;&amp; !empty($config-&gt;categories)) {</span>
<a name="l-3"></a><span class="x">        if(!empty($config-&gt;gcse_field) &amp;&amp; !empty($roles) &amp;&amp; !empty($categories)) {</span>
<a name="l-4"></a><span class="x">            if(!$DB-&gt;get_records(&#39;report_targetgrades_alisdata&#39;)) {</span>
<a name="l-5"></a><span class="x">                redirect(new moodle_url(&#39;/admin/report/targetgrades/alisdata.php&#39;));</span>
<a name="l-6"></a><span class="x">            } else {</span>
<a name="l-7"></a><span class="x">                redirect(new moodle_url(&#39;/admin/report/targetgrades/distribute.php&#39;));</span>
<a name="l-8"></a><span class="x">            }    </span>
<a name="l-9"></a><span class="x">        } else {</span>
<a name="l-10"></a><span class="x">            throw new tg\needsconfig_exception();</span>
<a name="l-11"></a><span class="x">        }</span>
<a name="l-12"></a><span class="x">    </span>
<a name="l-13"></a><span class="x">    } else {</span>
<a name="l-14"></a><span class="x">        throw new tg\needsconfig_exception();</span>
<a name="l-15"></a><span class="x">    }</span>
<a name="l-16"></a><span class="x">} catch (tg\needsconfig_exception $e) {</span>
<a name="l-17"></a><span class="x">    $url = new moodle_url(&#39;/admin/report/targetgrades/settingsform.php&#39;, array());    </span>
<a name="l-18"></a><span class="x">    redirect($url-&gt;out(), get_string(&#39;needsconfig&#39;, &#39;report_targetgrades&#39;), 5);</span>
<a name="l-19"></a><span class="x">}</span>
<a name="l-20"></a>
<a name="l-21"></a><span class="x">?&gt;</span>
</pre></div>
