<div class="highlight"><pre><a name="l-1"></a><span class="cp">&lt;?php</span>
<a name="l-2"></a><span class="c1">// This file is part of Moodle - http://moodle.org/</span>
<a name="l-3"></a><span class="c1">//</span>
<a name="l-4"></a><span class="c1">// Moodle is free software: you can redistribute it and/or modify</span>
<a name="l-5"></a><span class="c1">// it under the terms of the GNU General Public License as published by</span>
<a name="l-6"></a><span class="c1">// the Free Software Foundation, either version 3 of the License, or</span>
<a name="l-7"></a><span class="c1">// (at your option) any later version.</span>
<a name="l-8"></a><span class="c1">//</span>
<a name="l-9"></a><span class="c1">// Moodle is distributed in the hope that it will be useful,</span>
<a name="l-10"></a><span class="c1">// but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l-11"></a><span class="c1">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l-12"></a><span class="c1">// GNU General Public License for more details.</span>
<a name="l-13"></a><span class="c1">//</span>
<a name="l-14"></a><span class="c1">// You should have received a copy of the GNU General Public License</span>
<a name="l-15"></a><span class="c1">// along with Moodle.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<a name="l-16"></a>
<a name="l-17"></a>
<a name="l-18"></a><span class="sd">/**</span>
<a name="l-19"></a><span class="sd"> * Distribute and Calulate Target Grades</span>
<a name="l-20"></a><span class="sd"> *</span>
<a name="l-21"></a><span class="sd"> * Displays a Big Select List to allow selection of courses for grades to be </span>
<a name="l-22"></a><span class="sd"> * distributed to. </span>
<a name="l-23"></a><span class="sd"> * When the form Calculate button is pressed, each selected course has </span>
<a name="l-24"></a><span class="sd"> * the 4 required grade items created if necessary, and the grades for each student are</span>
<a name="l-25"></a><span class="sd"> * calculated and entered. The gradebook is then re-sorted to move the target </span>
<a name="l-26"></a><span class="sd"> * grade items to the front.</span>
<a name="l-27"></a><span class="sd"> * If the Recalculate button is pressed, the grades on the pages which already</span>
<a name="l-28"></a><span class="sd"> * have the grade items on are recalculated.</span>
<a name="l-29"></a><span class="sd"> * </span>
<a name="l-30"></a><span class="sd"> * @package report</span>
<a name="l-31"></a><span class="sd"> * @subpackage targetgrades</span>
<a name="l-32"></a><span class="sd"> * @author      Mark Johnson &lt;mark.johnson@tauntons.ac.uk&gt;</span>
<a name="l-33"></a><span class="sd"> * @copyright   2011 Tauntons College, UK</span>
<a name="l-34"></a><span class="sd"> * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later</span>
<a name="l-35"></a><span class="sd"> */</span> 
<a name="l-36"></a>
<a name="l-37"></a><span class="k">require_once</span><span class="p">(</span><span class="s1">&#39;../../../config.php&#39;</span><span class="p">);</span>
<a name="l-38"></a><span class="k">require_once</span><span class="p">(</span><span class="nv">$CFG</span><span class="o">-&gt;</span><span class="na">libdir</span><span class="o">.</span><span class="s1">&#39;/gradelib.php&#39;</span><span class="p">);</span>
<a name="l-39"></a><span class="k">require_once</span><span class="p">(</span><span class="nv">$CFG</span><span class="o">-&gt;</span><span class="na">dirroot</span><span class="o">.</span><span class="s1">&#39;/user/selector/lib.php&#39;</span><span class="p">);</span>
<a name="l-40"></a><span class="k">require_once</span><span class="p">(</span><span class="nv">$CFG</span><span class="o">-&gt;</span><span class="na">libdir</span><span class="o">.</span><span class="s1">&#39;/adminlib.php&#39;</span><span class="p">);</span>
<a name="l-41"></a><span class="k">require_once</span><span class="p">(</span><span class="nv">$CFG</span><span class="o">-&gt;</span><span class="na">dirroot</span><span class="o">.</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="nv">$CFG</span><span class="o">-&gt;</span><span class="na">admin</span><span class="o">.</span><span class="s1">&#39;/report/targetgrades/lib.php&#39;</span><span class="p">);</span>
<a name="l-42"></a>
<a name="l-43"></a><span class="k">use</span> <span class="nx">report\targetgrades</span> <span class="k">as</span> <span class="nx">tg</span><span class="p">;</span>
<a name="l-44"></a>
<a name="l-45"></a><span class="nx">require_login</span><span class="p">(</span><span class="nv">$SITE</span><span class="p">);</span>
<a name="l-46"></a><span class="nx">admin_externalpage_setup</span><span class="p">(</span><span class="s1">&#39;reporttargetgrades&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="nv">$CFG</span><span class="o">-&gt;</span><span class="na">admin</span><span class="o">.</span><span class="s1">&#39;/report/targetgrades/distribute.php&#39;</span><span class="p">);</span>
<a name="l-47"></a><span class="nv">$PAGE</span><span class="o">-&gt;</span><span class="na">navbar</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;mtgdistribute&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">));</span>
<a name="l-48"></a>
<a name="l-49"></a>
<a name="l-50"></a><span class="nv">$context</span> <span class="o">=</span> <span class="nx">get_context_instance</span><span class="p">(</span><span class="nx">CONTEXT_SYSTEM</span><span class="p">);</span>
<a name="l-51"></a><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">has_capability</span><span class="p">(</span><span class="s1">&#39;report/targetgrades:distribute&#39;</span><span class="p">,</span> <span class="nv">$context</span><span class="p">)){</span>
<a name="l-52"></a>    <span class="nx">print_error</span><span class="p">(</span><span class="s1">&#39;noperms&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">);</span>
<a name="l-53"></a><span class="p">}</span>
<a name="l-54"></a>
<a name="l-55"></a><span class="nv">$defaultscale</span> <span class="o">=</span> <span class="nx">optional_param</span><span class="p">(</span><span class="s1">&#39;defaultscale&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="nx">PARAM_INT</span><span class="p">);</span>
<a name="l-56"></a><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$defaultscale</span><span class="p">))</span> <span class="p">{</span>
<a name="l-57"></a>    <span class="nx">set_config</span><span class="p">(</span><span class="s1">&#39;defaultscale&#39;</span><span class="p">,</span> <span class="nv">$defaultscale</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">);</span>
<a name="l-58"></a><span class="p">}</span>
<a name="l-59"></a>
<a name="l-60"></a><span class="nv">$config</span> <span class="o">=</span> <span class="nx">tg\get_config</span><span class="p">();</span> <span class="c1">// Get the raw config data for the block</span>
<a name="l-61"></a>
<a name="l-62"></a><span class="k">if</span><span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">&#39;/(.+?\.?[*+].*?)[*+]/&#39;</span><span class="p">,</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="na">exclude_regex</span><span class="p">))</span> <span class="p">{</span>
<a name="l-63"></a>    <span class="nx">print_error</span><span class="p">(</span><span class="s1">&#39;unsaferegex&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">);</span>
<a name="l-64"></a><span class="p">}</span>
<a name="l-65"></a>
<a name="l-66"></a><span class="nv">$potential_selector</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">tg\potential_course_selector</span><span class="p">(</span><span class="s1">&#39;potentialcourses&#39;</span><span class="p">);</span>
<a name="l-67"></a><span class="nv">$distributed_selector</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">tg\distributed_course_selector</span><span class="p">(</span><span class="s1">&#39;distributedcourses&#39;</span><span class="p">);</span> 
<a name="l-68"></a>
<a name="l-69"></a><span class="nv">$potential_selector</span><span class="o">-&gt;</span><span class="na">exclude</span><span class="p">(</span><span class="nb">array_keys</span><span class="p">(</span><span class="nb">current</span><span class="p">(</span><span class="nv">$distributed_selector</span><span class="o">-&gt;</span><span class="na">find_users</span><span class="p">())));</span>
<a name="l-70"></a>
<a name="l-71"></a><span class="nv">$courses</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<a name="l-72"></a><span class="k">if</span> <span class="p">(</span><span class="nx">optional_param</span><span class="p">(</span><span class="s1">&#39;calculate&#39;</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="nx">PARAM_TEXT</span><span class="p">))</span> <span class="p">{</span>
<a name="l-73"></a>    <span class="nv">$courses</span> <span class="o">=</span> <span class="nv">$potential_selector</span><span class="o">-&gt;</span><span class="na">get_selected_users</span><span class="p">();</span> 
<a name="l-74"></a><span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">optional_param</span><span class="p">(</span><span class="s1">&#39;recalculate&#39;</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="nx">PARAM_TEXT</span><span class="p">))</span> <span class="p">{</span>
<a name="l-75"></a>    <span class="nv">$courses</span> <span class="o">=</span> <span class="nb">current</span><span class="p">(</span><span class="nv">$distributed_selector</span><span class="o">-&gt;</span><span class="na">find_users</span><span class="p">());</span>
<a name="l-76"></a><span class="p">}</span>
<a name="l-77"></a>
<a name="l-78"></a>
<a name="l-79"></a><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$courses</span><span class="p">))</span> <span class="p">{</span>  
<a name="l-80"></a>    
<a name="l-81"></a>	<span class="nb">set_time_limit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="c1">// This could take a while, so disable max execution time</span>
<a name="l-82"></a>    <span class="nv">$output</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
<a name="l-83"></a>
<a name="l-84"></a>    <span class="nv">$itemnames</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;target&#39;</span>   <span class="o">=&gt;</span>  <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;item_mtg&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">),</span>
<a name="l-85"></a>                        <span class="s1">&#39;min&#39;</span>  <span class="o">=&gt;</span>  <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;item_alis&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">),</span>
<a name="l-86"></a>                        <span class="s1">&#39;alisnum&#39;</span> <span class="o">=&gt;</span>    <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;item_alisnum&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">),</span>
<a name="l-87"></a>                        <span class="s1">&#39;avgcse&#39;</span> <span class="o">=&gt;</span> <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;item_avgcse&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">),</span>
<a name="l-88"></a>                        <span class="s1">&#39;cpg&#39;</span> <span class="o">=&gt;</span> <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;item_cpg&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">));</span>
<a name="l-89"></a>    <span class="nv">$empty_courses</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<a name="l-90"></a>    <span class="nv">$unconfigured_courses</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<a name="l-91"></a>    <span class="nv">$empty_students</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<a name="l-92"></a>    <span class="nv">$failed_grade_calcs</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<a name="l-93"></a>    <span class="nv">$errors</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
<a name="l-94"></a>    <span class="nv">$infofield</span> <span class="o">=</span> <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">get_record</span><span class="p">(</span><span class="s1">&#39;user_info_field&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="na">gcse_field</span><span class="p">));</span>
<a name="l-95"></a>
<a name="l-96"></a>    <span class="k">foreach</span><span class="p">(</span><span class="nv">$courses</span> <span class="k">as</span> <span class="nv">$course</span><span class="p">)</span> <span class="p">{</span>
<a name="l-97"></a>        <span class="nv">$category</span> <span class="o">=</span> <span class="nx">grade_category</span><span class="o">::</span><span class="na">fetch_course_category</span><span class="p">(</span><span class="nv">$course</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">);</span>
<a name="l-98"></a>
<a name="l-99"></a>        <span class="nv">$records</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
<a name="l-100"></a>
<a name="l-101"></a>        <span class="nv">$regrade</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
<a name="l-102"></a>        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$itemnames</span> <span class="k">as</span> <span class="nv">$item</span> <span class="o">=&gt;</span> <span class="nv">$itemname</span><span class="p">)</span> <span class="p">{</span>
<a name="l-103"></a>            <span class="k">try</span> <span class="p">{</span>
<a name="l-104"></a>                <span class="k">if</span><span class="p">(</span><span class="nv">$grade_item</span> <span class="o">=</span> <span class="nx">grade_item</span><span class="o">::</span><span class="na">fetch</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;idnumber&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;targetgrades_&#39;</span><span class="o">.</span><span class="nv">$item</span><span class="p">,</span> <span class="s1">&#39;courseid&#39;</span><span class="o">=&gt;</span><span class="nv">$course</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">)))</span> <span class="p">{</span>
<a name="l-105"></a>                    <span class="nv">$itemdata</span> <span class="o">=</span> <span class="k">new</span> <span class="k">stdClass</span><span class="p">();</span>
<a name="l-106"></a>                    <span class="k">if</span><span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$grade_item</span><span class="o">-&gt;</span><span class="na">timecreated</span><span class="p">))</span> <span class="p">{</span>
<a name="l-107"></a>                        <span class="nv">$itemdata</span><span class="o">-&gt;</span><span class="na">timecreated</span> <span class="o">=</span> <span class="nb">time</span><span class="p">();</span>
<a name="l-108"></a>                    <span class="p">}</span>
<a name="l-109"></a>                    <span class="k">if</span><span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$grade_item</span><span class="o">-&gt;</span><span class="na">itemnumber</span><span class="p">))</span> <span class="p">{</span>
<a name="l-110"></a>                        <span class="nv">$itemdata</span><span class="o">-&gt;</span><span class="na">itemnumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="l-111"></a>                    <span class="p">}</span>
<a name="l-112"></a>                    <span class="nx">grade_item</span><span class="o">::</span><span class="na">set_properties</span><span class="p">(</span><span class="nv">$grade_item</span><span class="p">,</span> <span class="nv">$itemdata</span><span class="p">);</span>
<a name="l-113"></a>                    <span class="nv">$grade_item</span><span class="o">-&gt;</span><span class="na">update</span><span class="p">();</span>
<a name="l-114"></a>                    <span class="nb">unset</span><span class="p">(</span><span class="nv">$itemdata</span><span class="p">);</span>
<a name="l-115"></a>                    <span class="k">throw</span> <span class="k">new</span> <span class="nx">tg\grade_item_exists_exception</span><span class="p">(</span><span class="nv">$item</span><span class="p">,</span> <span class="nv">$grade_item</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">);</span>
<a name="l-116"></a>                <span class="p">}</span>
<a name="l-117"></a>
<a name="l-118"></a>                <span class="nv">$itemclass</span> <span class="o">=</span> <span class="s1">&#39;report\targetgrades\item_&#39;</span><span class="o">.</span><span class="nv">$item</span><span class="p">;</span>
<a name="l-119"></a>                <span class="nv">$itemdata</span> <span class="o">=</span> <span class="k">new</span> <span class="nv">$itemclass</span><span class="p">(</span><span class="nv">$course</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">,</span> <span class="nv">$category</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">);</span>
<a name="l-120"></a>                <span class="k">if</span> <span class="p">(</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$item</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;cpg&#39;</span><span class="p">)))</span> <span class="p">{</span>
<a name="l-121"></a>                    <span class="k">try</span> <span class="p">{</span>
<a name="l-122"></a>                        <span class="nv">$itemdata</span><span class="o">-&gt;</span><span class="na">set_scale</span><span class="p">(</span><span class="nv">$course</span><span class="o">-&gt;</span><span class="na">qualtype</span><span class="p">,</span> <span class="nv">$defaultscale</span><span class="p">);</span>
<a name="l-123"></a>                    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
<a name="l-124"></a>                        <span class="nv">$failed_grade_calcs</span><span class="o">++</span><span class="p">;</span>
<a name="l-125"></a>                        <span class="nv">$errors</span> <span class="o">.=</span> <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;nogradescale&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">,</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">())</span><span class="o">.</span><span class="s1">&#39;&lt;br /&gt;&#39;</span><span class="p">;</span>
<a name="l-126"></a>                    <span class="p">}</span>
<a name="l-127"></a>                <span class="p">}</span>
<a name="l-128"></a>
<a name="l-129"></a>                <span class="nv">$grade_item</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">grade_item</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;courseid&#39;</span><span class="o">=&gt;</span><span class="nv">$course</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">,</span> <span class="s1">&#39;itemtype&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;manual&#39;</span><span class="p">),</span> <span class="k">false</span><span class="p">);</span>
<a name="l-130"></a>                <span class="nx">grade_item</span><span class="o">::</span><span class="na">set_properties</span><span class="p">(</span><span class="nv">$grade_item</span><span class="p">,</span> <span class="nv">$itemdata</span><span class="p">);</span>
<a name="l-131"></a>                <span class="nv">$itemids</span><span class="p">[</span><span class="nv">$item</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$grade_item</span><span class="o">-&gt;</span><span class="na">insert</span><span class="p">();</span>
<a name="l-132"></a>                <span class="nv">$regrade</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
<a name="l-133"></a>
<a name="l-134"></a>            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">tg\grade_item_exists_exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
<a name="l-135"></a>                <span class="nv">$itemids</span><span class="p">[</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">()]</span> <span class="o">=</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getId</span><span class="p">();</span>
<a name="l-136"></a>            <span class="p">}</span>
<a name="l-137"></a>
<a name="l-138"></a>        <span class="p">}</span>
<a name="l-139"></a>
<a name="l-140"></a>        <span class="k">if</span><span class="p">(</span><span class="nv">$course</span><span class="o">-&gt;</span><span class="na">qualtype</span><span class="p">)</span> <span class="p">{</span>
<a name="l-141"></a>            <span class="c1">// Get the ID and average GCSE score of all students in the course</span>
<a name="l-142"></a>
<a name="l-143"></a>            <span class="nv">$coursecontext</span> <span class="o">=</span> <span class="nx">get_context_instance</span><span class="p">(</span><span class="nx">CONTEXT_COURSE</span><span class="p">,</span> <span class="nv">$course</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">);</span>
<a name="l-144"></a>
<a name="l-145"></a>            <span class="nv">$select</span> <span class="o">=</span> <span class="s1">&#39;SELECT u.id AS id &#39;</span><span class="p">;</span>
<a name="l-146"></a>
<a name="l-147"></a>            <span class="nv">$from</span> <span class="o">=</span> <span class="s1">&#39;FROM {user} u</span>
<a name="l-148"></a><span class="s1">                    JOIN {role_assignments} ra</span>
<a name="l-149"></a><span class="s1">                        ON u.id = ra.userid &#39;</span><span class="p">;</span>
<a name="l-150"></a>			
<a name="l-151"></a>			<span class="k">list</span><span class="p">(</span><span class="nv">$in_sql</span><span class="p">,</span> <span class="nv">$in_params</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">get_in_or_equal</span><span class="p">(</span><span class="nv">$config</span><span class="o">-&gt;</span><span class="na">roles</span><span class="p">);</span>
<a name="l-152"></a>            <span class="nv">$params</span> <span class="o">=</span> <span class="nb">array_merge</span><span class="p">(</span><span class="nv">$in_params</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$coursecontext</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">));</span>
<a name="l-153"></a>            <span class="nv">$where</span> <span class="o">=</span> <span class="s1">&#39;WHERE u.deleted = 0</span>
<a name="l-154"></a><span class="s1">                        AND ra.roleid &#39;</span><span class="o">.</span><span class="nv">$in_sql</span><span class="o">.</span><span class="s1">&#39;</span>
<a name="l-155"></a><span class="s1">                        AND ra.contextid = ?&#39;</span><span class="p">;</span>
<a name="l-156"></a>
<a name="l-157"></a>            <span class="k">try</span> <span class="p">{</span>
<a name="l-158"></a>                <span class="nv">$students</span> <span class="o">=</span> <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">get_records_sql</span><span class="p">(</span><span class="nv">$select</span><span class="o">.</span><span class="nv">$from</span><span class="o">.</span><span class="nv">$where</span><span class="p">,</span> <span class="nv">$params</span><span class="p">);</span>
<a name="l-159"></a>
<a name="l-160"></a>                <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$students</span><span class="p">)</span> <span class="p">{</span>
<a name="l-161"></a>                    <span class="k">throw</span> <span class="k">new</span> <span class="nx">tg\no_students_exception</span><span class="p">(</span><span class="nv">$course</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">);</span>
<a name="l-162"></a>                <span class="p">}</span>
<a name="l-163"></a>
<a name="l-164"></a>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$course</span><span class="o">-&gt;</span><span class="na">pattern</span><span class="p">))</span> <span class="p">{</span>
<a name="l-165"></a>                    <span class="k">throw</span> <span class="k">new</span> <span class="nx">tg\no_config_for_course_exception</span><span class="p">(</span><span class="nv">$course</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">);</span>
<a name="l-166"></a>                <span class="p">}</span>
<a name="l-167"></a>
<a name="l-168"></a>                <span class="c1">// If there are some students in the class</span>
<a name="l-169"></a>                <span class="k">foreach</span><span class="p">(</span><span class="nv">$students</span> <span class="k">as</span> <span class="nv">$student</span><span class="p">)</span> <span class="p">{</span>
<a name="l-170"></a>                    <span class="k">if</span><span class="p">(</span><span class="nv">$data</span> <span class="o">=</span> <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">get_record</span><span class="p">(</span><span class="s1">&#39;user_info_data&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;fieldid&#39;</span> <span class="o">=&gt;</span> <span class="nv">$infofield</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">,</span> <span class="s1">&#39;userid&#39;</span> <span class="o">=&gt;</span> <span class="nv">$student</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">)))</span> <span class="p">{</span>
<a name="l-171"></a>                        <span class="nv">$student</span><span class="o">-&gt;</span><span class="na">avgcse</span> <span class="o">=</span> <span class="nv">$data</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">;</span>
<a name="l-172"></a>                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="l-173"></a>                        <span class="nv">$student</span><span class="o">-&gt;</span><span class="na">avgcse</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
<a name="l-174"></a>                    <span class="p">}</span>
<a name="l-175"></a>
<a name="l-176"></a>                    <span class="k">try</span> <span class="p">{</span>
<a name="l-177"></a>                        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$student</span><span class="o">-&gt;</span><span class="na">avgcse</span><span class="p">))</span> <span class="p">{</span>
<a name="l-178"></a>                            <span class="k">throw</span> <span class="k">new</span> <span class="nx">tg\no_data_for_student_exception</span><span class="p">(</span><span class="nv">$student</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">);</span>
<a name="l-179"></a>                        <span class="p">}</span>
<a name="l-180"></a>
<a name="l-181"></a>                        <span class="k">if</span><span class="p">(</span><span class="nv">$avgcse</span> <span class="o">=</span> <span class="nx">grade_grade</span><span class="o">::</span><span class="na">fetch</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;itemid&#39;</span> <span class="o">=&gt;</span> <span class="nv">$itemids</span><span class="p">[</span><span class="s1">&#39;avgcse&#39;</span><span class="p">],</span> <span class="s1">&#39;userid&#39;</span> <span class="o">=&gt;</span> <span class="nv">$student</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">)))</span> <span class="p">{</span>
<a name="l-182"></a>                            <span class="c1">// If they&#39;ve already got an average gcse grade, update it</span>
<a name="l-183"></a>                            <span class="nv">$avgcse</span><span class="o">-&gt;</span><span class="na">rawgrade</span> <span class="o">=</span> <span class="nv">$student</span><span class="o">-&gt;</span><span class="na">avgcse</span><span class="p">;</span>
<a name="l-184"></a>                            <span class="nv">$avgcse</span><span class="o">-&gt;</span><span class="na">finalgrade</span> <span class="o">=</span> <span class="nv">$student</span><span class="o">-&gt;</span><span class="na">avgcse</span><span class="p">;</span>
<a name="l-185"></a>                            <span class="nv">$avgcse</span><span class="o">-&gt;</span><span class="na">timemodified</span> <span class="o">=</span> <span class="nb">time</span><span class="p">();</span>
<a name="l-186"></a>                            <span class="nv">$avgcse</span><span class="o">-&gt;</span><span class="na">update</span><span class="p">(</span><span class="s1">&#39;report_targetgrades&#39;</span><span class="p">);</span>
<a name="l-187"></a>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="l-188"></a>                            <span class="nv">$avgcse</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">grade_grade</span><span class="p">();</span>
<a name="l-189"></a>                            <span class="nv">$avgcse</span><span class="o">-&gt;</span><span class="na">itemid</span> <span class="o">=</span> <span class="nv">$itemids</span><span class="p">[</span><span class="s1">&#39;avgcse&#39;</span><span class="p">];</span>
<a name="l-190"></a>                            <span class="nv">$avgcse</span><span class="o">-&gt;</span><span class="na">userid</span> <span class="o">=</span> <span class="nv">$student</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">;</span>
<a name="l-191"></a>                            <span class="nv">$avgcse</span><span class="o">-&gt;</span><span class="na">rawgrade</span> <span class="o">=</span> <span class="nv">$student</span><span class="o">-&gt;</span><span class="na">avgcse</span><span class="p">;</span>
<a name="l-192"></a>                            <span class="nv">$avgcse</span><span class="o">-&gt;</span><span class="na">finalgrade</span> <span class="o">=</span> <span class="nv">$student</span><span class="o">-&gt;</span><span class="na">avgcse</span><span class="p">;</span>
<a name="l-193"></a>                            <span class="nv">$avgcse</span><span class="o">-&gt;</span><span class="na">timecreated</span> <span class="o">=</span> <span class="nb">time</span><span class="p">();</span>
<a name="l-194"></a>                            <span class="nv">$avgcse</span><span class="o">-&gt;</span><span class="na">timemodified</span> <span class="o">=</span> <span class="nb">time</span><span class="p">();</span>
<a name="l-195"></a>                            <span class="nv">$avgcse</span><span class="o">-&gt;</span><span class="na">insert</span><span class="p">(</span><span class="s1">&#39;report_targetgrades&#39;</span><span class="p">);</span>
<a name="l-196"></a>                        <span class="p">}</span>
<a name="l-197"></a>
<a name="l-198"></a>                        <span class="nv">$mtg</span> <span class="o">=</span> <span class="nx">tg\calculate_mtg</span><span class="p">(</span><span class="nv">$student</span><span class="p">,</span> <span class="nv">$course</span><span class="p">);</span>
<a name="l-199"></a>
<a name="l-200"></a>                        <span class="k">if</span><span class="p">(</span><span class="nv">$alis</span> <span class="o">=</span> <span class="nx">grade_grade</span><span class="o">::</span><span class="na">fetch</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;itemid&#39;</span> <span class="o">=&gt;</span> <span class="nv">$itemids</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">],</span> <span class="s1">&#39;userid&#39;</span> <span class="o">=&gt;</span> <span class="nv">$student</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">)))</span> <span class="p">{</span>
<a name="l-201"></a>                            <span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">rawgrade</span> <span class="o">=</span> <span class="nv">$mtg</span><span class="p">[</span><span class="s1">&#39;grade&#39;</span><span class="p">];</span>
<a name="l-202"></a>                            <span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">finalgrade</span> <span class="o">=</span> <span class="nv">$mtg</span><span class="p">[</span><span class="s1">&#39;grade&#39;</span><span class="p">];</span>
<a name="l-203"></a>                            <span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">timemodified</span> <span class="o">=</span> <span class="nb">time</span><span class="p">();</span>
<a name="l-204"></a>                            <span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">update</span><span class="p">(</span><span class="s1">&#39;report_targetgrades&#39;</span><span class="p">);</span>
<a name="l-205"></a>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="l-206"></a>                            <span class="nv">$alis</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">grade_grade</span><span class="p">();</span>
<a name="l-207"></a>                            <span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">itemid</span> <span class="o">=</span> <span class="nv">$itemids</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">];</span>
<a name="l-208"></a>                            <span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">userid</span> <span class="o">=</span> <span class="nv">$student</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">;</span>
<a name="l-209"></a>                            <span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">rawgrade</span> <span class="o">=</span> <span class="nv">$mtg</span><span class="p">[</span><span class="s1">&#39;grade&#39;</span><span class="p">];</span>
<a name="l-210"></a>                            <span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">finalgrade</span> <span class="o">=</span> <span class="nv">$mtg</span><span class="p">[</span><span class="s1">&#39;grade&#39;</span><span class="p">];</span>
<a name="l-211"></a>                            <span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">timecreated</span> <span class="o">=</span> <span class="nb">time</span><span class="p">();</span>
<a name="l-212"></a>                            <span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">timemodified</span> <span class="o">=</span> <span class="nb">time</span><span class="p">();</span>
<a name="l-213"></a>                            <span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">insert</span><span class="p">(</span><span class="s1">&#39;report_targetgrades&#39;</span><span class="p">);</span>
<a name="l-214"></a>                        <span class="p">}</span>
<a name="l-215"></a>
<a name="l-216"></a>                        <span class="k">if</span><span class="p">(</span><span class="nv">$alis_num</span> <span class="o">=</span> <span class="nx">grade_grade</span><span class="o">::</span><span class="na">fetch</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;itemid&#39;</span> <span class="o">=&gt;</span> <span class="nv">$itemids</span><span class="p">[</span><span class="s1">&#39;alisnum&#39;</span><span class="p">],</span> <span class="s1">&#39;userid&#39;</span> <span class="o">=&gt;</span> <span class="nv">$student</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">))){</span>
<a name="l-217"></a>                            <span class="nv">$alis_num</span><span class="o">-&gt;</span><span class="na">rawgrade</span> <span class="o">=</span> <span class="nv">$mtg</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">];</span>
<a name="l-218"></a>                            <span class="nv">$alis_num</span><span class="o">-&gt;</span><span class="na">finalgrade</span> <span class="o">=</span> <span class="nv">$mtg</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">];</span>
<a name="l-219"></a>                            <span class="nv">$alis_num</span><span class="o">-&gt;</span><span class="na">timemodified</span> <span class="o">=</span> <span class="nb">time</span><span class="p">();</span>
<a name="l-220"></a>                            <span class="nv">$alis_num</span><span class="o">-&gt;</span><span class="na">update</span><span class="p">(</span><span class="s1">&#39;report_targetgrades&#39;</span><span class="p">);</span>
<a name="l-221"></a>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="l-222"></a>                            <span class="nv">$alis_num</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">grade_grade</span><span class="p">();</span>
<a name="l-223"></a>                            <span class="nv">$alis_num</span><span class="o">-&gt;</span><span class="na">itemid</span> <span class="o">=</span> <span class="nv">$itemids</span><span class="p">[</span><span class="s1">&#39;alisnum&#39;</span><span class="p">];</span>
<a name="l-224"></a>                            <span class="nv">$alis_num</span><span class="o">-&gt;</span><span class="na">userid</span> <span class="o">=</span> <span class="nv">$student</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">;</span>
<a name="l-225"></a>                            <span class="nv">$alis_num</span><span class="o">-&gt;</span><span class="na">rawgrade</span> <span class="o">=</span> <span class="nv">$mtg</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">];</span>
<a name="l-226"></a>                            <span class="nv">$alis_num</span><span class="o">-&gt;</span><span class="na">finalgrade</span> <span class="o">=</span> <span class="nv">$mtg</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">];</span>
<a name="l-227"></a>                            <span class="nv">$alis_num</span><span class="o">-&gt;</span><span class="na">timecreated</span> <span class="o">=</span> <span class="nb">time</span><span class="p">();</span>
<a name="l-228"></a>                            <span class="nv">$alis_num</span><span class="o">-&gt;</span><span class="na">timemodified</span> <span class="o">=</span> <span class="nb">time</span><span class="p">();</span>
<a name="l-229"></a>                            <span class="nv">$alis_num</span><span class="o">-&gt;</span><span class="na">insert</span><span class="p">(</span><span class="s1">&#39;report_targetgrades&#39;</span><span class="p">);</span>
<a name="l-230"></a>                        <span class="p">}</span>
<a name="l-231"></a>
<a name="l-232"></a>                    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">tg\no_data_for_student_exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
<a name="l-233"></a>                        <span class="nv">$empty_students</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">();</span>
<a name="l-234"></a>                    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">tg\no_mtg_for_student_exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
<a name="l-235"></a>                        <span class="nv">$failed_grade_calcs</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">();</span>
<a name="l-236"></a>                    <span class="p">}</span>
<a name="l-237"></a>
<a name="l-238"></a>                <span class="p">}</span>
<a name="l-239"></a>
<a name="l-240"></a>            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">tg\no_students_exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
<a name="l-241"></a>                <span class="nv">$empty_courses</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">();</span>
<a name="l-242"></a>            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">tg\no_config_for_course_exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
<a name="l-243"></a>                <span class="nv">$unconfigured_courses</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">();</span>
<a name="l-244"></a>            <span class="p">}</span>
<a name="l-245"></a>            <span class="k">if</span><span class="p">(</span><span class="nv">$regrade</span><span class="p">)</span> <span class="p">{</span>
<a name="l-246"></a>                <span class="nx">grade_regrade_final_grades</span><span class="p">(</span><span class="nv">$course</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">);</span>
<a name="l-247"></a>                <span class="nx">tg\sort_gradebook</span><span class="p">(</span><span class="nv">$course</span><span class="p">);</span>
<a name="l-248"></a>            <span class="p">}</span>
<a name="l-249"></a>        <span class="p">}</span>
<a name="l-250"></a>    <span class="p">}</span>
<a name="l-251"></a>
<a name="l-252"></a>    <span class="nv">$output</span> <span class="o">=</span> <span class="nx">html_writer</span><span class="o">::</span><span class="na">start_tag</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span><span class="o">.</span>
<a name="l-253"></a>    <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;distribute_success&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">,</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$distributed_selector</span><span class="o">-&gt;</span><span class="na">find_users</span><span class="p">())</span><span class="o">-</span><span class="nb">count</span><span class="p">(</span><span class="nv">$empty_courses</span><span class="p">)</span><span class="o">-</span><span class="nb">count</span><span class="p">(</span><span class="nv">$unconfigured_courses</span><span class="p">))</span><span class="o">.</span>
<a name="l-254"></a>    <span class="nx">html_writer</span><span class="o">::</span><span class="na">empty_tag</span><span class="p">(</span><span class="s1">&#39;br&#39;</span><span class="p">)</span><span class="o">.</span>
<a name="l-255"></a>    <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;distribute_empty&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">,</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$empty_courses</span><span class="p">))</span><span class="o">.</span>
<a name="l-256"></a>    <span class="nx">html_writer</span><span class="o">::</span><span class="na">empty_tag</span><span class="p">(</span><span class="s1">&#39;br&#39;</span><span class="p">)</span><span class="o">.</span>
<a name="l-257"></a>    <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;distribute_unconfigured&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">,</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$unconfigured_courses</span><span class="p">))</span><span class="o">.</span>
<a name="l-258"></a>    <span class="nx">html_writer</span><span class="o">::</span><span class="na">empty_tag</span><span class="p">(</span><span class="s1">&#39;br&#39;</span><span class="p">)</span><span class="o">.</span>
<a name="l-259"></a>    <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;distribute_noavgcse&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">,</span> <span class="nb">count</span><span class="p">(</span><span class="nb">array_unique</span><span class="p">(</span><span class="nv">$empty_students</span><span class="p">)))</span><span class="o">.</span>
<a name="l-260"></a>    <span class="nx">html_writer</span><span class="o">::</span><span class="na">empty_tag</span><span class="p">(</span><span class="s1">&#39;br&#39;</span><span class="p">)</span><span class="o">.</span>
<a name="l-261"></a>    <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;distribute_failedcalc&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">,</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$failed_grade_calcs</span><span class="p">))</span><span class="o">.</span>
<a name="l-262"></a>    <span class="nx">html_writer</span><span class="o">::</span><span class="na">empty_tag</span><span class="p">(</span><span class="s1">&#39;br&#39;</span><span class="p">)</span><span class="o">.</span>
<a name="l-263"></a>    <span class="nv">$errors</span><span class="o">.</span>
<a name="l-264"></a>    <span class="nx">html_writer</span><span class="o">::</span><span class="na">end_tag</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">);</span>
<a name="l-265"></a>
<a name="l-266"></a><span class="p">}</span> 
<a name="l-267"></a>
<a name="l-268"></a>
<a name="l-269"></a><span class="nv">$table</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">html_table</span><span class="p">(</span><span class="s1">&#39;course_selector&#39;</span><span class="p">);</span>
<a name="l-270"></a><span class="nv">$row</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">html_table_row</span><span class="p">();</span>
<a name="l-271"></a><span class="nv">$row</span><span class="o">-&gt;</span><span class="na">cells</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$distributed_selector</span><span class="o">-&gt;</span><span class="na">display</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
<a name="l-272"></a><span class="nv">$cell</span> <span class="o">=</span> <span class="nx">html_writer</span><span class="o">::</span><span class="na">empty_tag</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;report_targetgrades_calcbutton&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;calculate&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;submit&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span> <span class="o">=&gt;</span> <span class="nv">$OUTPUT</span><span class="o">-&gt;</span><span class="na">larrow</span><span class="p">()</span><span class="o">.</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;calculategrades&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">)));</span>
<a name="l-273"></a><span class="nv">$cell</span> <span class="o">.=</span> <span class="nv">$OUTPUT</span><span class="o">-&gt;</span><span class="na">help_icon</span><span class="p">(</span><span class="s1">&#39;calculategrades&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">);</span>
<a name="l-274"></a><span class="nv">$row</span><span class="o">-&gt;</span><span class="na">cells</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$cell</span><span class="p">;</span>
<a name="l-275"></a><span class="nv">$row</span><span class="o">-&gt;</span><span class="na">cells</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$potential_selector</span><span class="o">-&gt;</span><span class="na">display</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
<a name="l-276"></a><span class="nv">$table</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$row</span><span class="p">;</span>
<a name="l-277"></a>
<a name="l-278"></a><span class="nv">$scales</span> <span class="o">=</span> <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">get_records_menu</span><span class="p">(</span><span class="s1">&#39;scale&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="s1">&#39;id, name&#39;</span><span class="p">);</span>
<a name="l-279"></a>
<a name="l-280"></a><span class="nv">$defaultscale</span> <span class="o">=</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$config</span><span class="o">-&gt;</span><span class="na">defaultscale</span><span class="p">))</span> <span class="o">?</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="na">defaultscale</span> <span class="o">:</span> <span class="k">null</span><span class="p">;</span>
<a name="l-281"></a>
<a name="l-282"></a><span class="k">echo</span> <span class="nv">$OUTPUT</span><span class="o">-&gt;</span><span class="na">header</span><span class="p">();</span>
<a name="l-283"></a><span class="nx">tg\print_tabs</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<a name="l-284"></a>
<a name="l-285"></a><span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$output</span><span class="p">))</span> <span class="p">{</span>
<a name="l-286"></a>    <span class="k">echo</span> <span class="nv">$output</span><span class="p">;</span>
<a name="l-287"></a><span class="p">}</span>
<a name="l-288"></a>
<a name="l-289"></a><span class="k">echo</span> <span class="nx">html_writer</span><span class="o">::</span><span class="na">start_tag</span><span class="p">(</span><span class="s1">&#39;form&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;action&#39;</span> <span class="o">=&gt;</span> <span class="nv">$PAGE</span><span class="o">-&gt;</span><span class="na">url</span><span class="o">-&gt;</span><span class="na">out</span><span class="p">(),</span> <span class="s1">&#39;method&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;post&#39;</span><span class="p">));</span>
<a name="l-290"></a><span class="k">echo</span> <span class="nx">html_writer</span><span class="o">::</span><span class="na">tag</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;defaultscale&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;for&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;defaultscale&#39;</span><span class="p">));</span>
<a name="l-291"></a><span class="k">echo</span> <span class="nx">html_writer</span><span class="o">::</span><span class="na">select</span><span class="p">(</span><span class="nv">$scales</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">,</span> <span class="nv">$defaultscale</span><span class="p">);</span>
<a name="l-292"></a><span class="k">echo</span> <span class="nv">$OUTPUT</span><span class="o">-&gt;</span><span class="na">help_icon</span><span class="p">(</span><span class="s1">&#39;defaultscale&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">);</span>
<a name="l-293"></a><span class="k">echo</span> <span class="nx">html_writer</span><span class="o">::</span><span class="na">table</span><span class="p">(</span><span class="nv">$table</span><span class="p">);</span>
<a name="l-294"></a><span class="k">echo</span> <span class="nx">html_writer</span><span class="o">::</span><span class="na">empty_tag</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;submit&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;recalculate&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span> <span class="o">=&gt;</span> <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;recalculate&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">)));</span>
<a name="l-295"></a><span class="k">echo</span> <span class="nv">$OUTPUT</span><span class="o">-&gt;</span><span class="na">help_icon</span><span class="p">(</span><span class="s1">&#39;recalculate&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">);</span>
<a name="l-296"></a><span class="k">echo</span> <span class="nx">html_writer</span><span class="o">::</span><span class="na">end_tag</span><span class="p">(</span><span class="s1">&#39;form&#39;</span><span class="p">);</span>
<a name="l-297"></a>
<a name="l-298"></a><span class="k">echo</span> <span class="nv">$OUTPUT</span><span class="o">-&gt;</span><span class="na">footer</span><span class="p">();</span>
<a name="l-299"></a>
<a name="l-300"></a><span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
